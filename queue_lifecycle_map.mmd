graph TD
    %% Queue Management Lifecycle - From "Call Next" to Complete Service
    
    %% External Entities
    STAFF[Staff/Teller ğŸ‘¤]
    CUST[Customer ğŸ‘¥]
    DISPLAY[Display Monitor ğŸ“º]
    AUDIO[Audio System ğŸ”Š]
    WEBSOCKET[WebSocket Clients ğŸŒ]
    SMS[SMS Provider ğŸ“±]
    
    %% Data Stores
    DS1[(DS1: Queue Database<br/>- customer status<br/>- queue position<br/>- timestamps)]
    DS2[(DS2: Service Counter DB<br/>- counter assignment<br/>- active status<br/>- current customer)]
    DS3[(DS3: Customer Database<br/>- customer details<br/>- phone numbers<br/>- priority flags)]
    DS4[(DS4: Activity Log<br/>- queue events<br/>- analytics data<br/>- audit trail)]
    
    %% === INITIATION PHASE ===
    STAFF -->|1. "Call Next" Request<br/>POST /api/queue/call-next<br/>{counterId}| P1[P1: Get Current Queue Status<br/>ğŸ” Query waiting customers<br/>ğŸ“Š Calculate priority scores<br/>â±ï¸ Check wait times]
    
    %% P1 Process Flow
    P1 -->|Queue Status Query<br/>SELECT * FROM customers<br/>WHERE queue_status='waiting'<br/>ORDER BY priority| DS1
    DS1 -->|Current Queue Data<br/>â€¢ Customer list<br/>â€¢ Priority flags<br/>â€¢ Timestamps| P1
    
    %% Decision Point - Customers Available
    P1 -->|âœ… Available Customers List<br/>Sorted by priority & time| P2[P2: Select Next Customer<br/>ğŸ¯ Priority algorithm<br/>ğŸ“‹ Customer selection<br/>ğŸ“ Contact details]
    P1 -->|âŒ No Customers Available<br/>Empty queue response| STAFF
    
    %% === SELECTION PHASE ===
    P2 -->|Customer Selection Query<br/>GET customer details| DS3
    DS3 -->|Customer Details<br/>â€¢ Name & contact<br/>â€¢ Priority flags<br/>â€¢ Service history| P2
    
    P2 -->|Selected Customer Info<br/>â€¢ Customer ID<br/>â€¢ Priority status<br/>â€¢ Wait time| P3[P3: Update Queue Position<br/>ğŸ“ Status = 'serving'<br/>â° Timestamp updates<br/>ğŸ“Š Position tracking]
    P2 -->|Customer Priority Rules<br/>â€¢ Senior citizen: +1000<br/>â€¢ PWD: +900<br/>â€¢ Pregnant: +800| P4[P4: Assign to Counter<br/>ğŸª Counter assignment<br/>ğŸ”„ Status updates<br/>ğŸ‘¤ Staff linkage]
    
    %% === UPDATE PHASE ===
    P3 -->|Position Update<br/>UPDATE customers SET<br/>queue_status='serving'<br/>updated_at=NOW()| DS1
    P3 -->|Queue Update Event<br/>INSERT INTO queue_events<br/>event_type='called'<br/>analytics data| DS4
    P3 -->|Customer Call Data<br/>â€¢ Customer info<br/>â€¢ Call timestamp<br/>â€¢ Counter assignment| P5[P5: Notify Customer<br/>ğŸ”” Multi-channel alerts<br/>ğŸ“± SMS notification<br/>ğŸ”Š Audio announcement<br/>ğŸ“º Display update<br/>ğŸŒ WebSocket broadcast]
    
    P4 -->|Counter Assignment<br/>UPDATE counters SET<br/>current_customer_id<br/>updated_at=NOW()| DS2
    P4 -->|Assignment Confirmation<br/>Counter + Customer link| P5
    
    %% === NOTIFICATION PHASE ===
    P5 -->|ğŸ”Š Audio Announcement<br/>TTS: "Customer [Name]<br/>Token #[Number]<br/>Counter [Name]"| AUDIO
    P5 -->|ğŸ“º Display Message<br/>Visual notification:<br/>"NOW SERVING<br/>Token #[Number]<br/>Counter [Name]"| DISPLAY
    P5 -->|ğŸ“± SMS Notification<br/>Template: "queue_position"<br/>Hi [Name], please proceed<br/>to Counter [Name] now"| SMS
    P5 -->|ğŸŒ WebSocket Update<br/>Real-time broadcast:<br/>customer_called event<br/>queue status update| WEBSOCKET
    P5 -->|âœ… Assignment Confirmation<br/>Success notification<br/>to requesting staff| STAFF
    
    %% === CUSTOMER RESPONSE PHASE ===
    CUST -->|ğŸ‘‹ Arrival Confirmation<br/>Physical presence<br/>or check-in| STAFF
    CUST -->|ğŸ“‹ Service Request Details<br/>Specific requirements<br/>or clarifications| STAFF
    
    %% === SERVICE COMPLETION PHASE ===
    STAFF -->|âœ… Service Complete<br/>POST /api/queue/complete<br/>{customerId, counterId}| P6[P6: Update Service Status<br/>ğŸ“ Status = 'completed'<br/>â±ï¸ Service time tracking<br/>ğŸª Counter cleanup]
    
    P6 -->|Service Status Update<br/>UPDATE customers SET<br/>queue_status='completed'<br/>updated_at=NOW()| DS1
    P6 -->|Counter Status Update<br/>UPDATE counters SET<br/>current_customer_id=NULL<br/>available for next| DS2
    P6 -->|Service Complete Event<br/>INSERT INTO queue_events<br/>event_type='served'<br/>service_time calculation| DS4
    P6 -->|ğŸ“Š Service Summary<br/>Completion confirmation<br/>Service duration<br/>Performance metrics| STAFF
    
    %% WebSocket notification for completion
    P6 -->|ğŸŒ WebSocket Update<br/>customer_completed event<br/>Counter now available| WEBSOCKET
    
    %% === NO-SHOW HANDLING PHASE ===
    STAFF -->|ğŸš« Customer No-Show<br/>POST /api/queue/cancel<br/>{customerId, reason}| P7[P7: Handle No-Show<br/>âš ï¸ Status = 'cancelled'<br/>ğŸ“ Reason logging<br/>ğŸ”„ Re-queue option]
    
    P7 -->|No-Show Status Update<br/>UPDATE customers SET<br/>queue_status='cancelled'<br/>remarks='No-show: [reason]'| DS1
    P7 -->|Counter Status Update<br/>UPDATE counters SET<br/>current_customer_id=NULL<br/>available for next| DS2
    P7 -->|No-Show Event<br/>INSERT INTO queue_events<br/>event_type='cancelled'<br/>reason='no_show'| DS4
    P7 -->|ğŸ”„ Re-queue Option<br/>Option to call again<br/>or reschedule| P1
    
    %% === ANALYTICS & MONITORING ===
    DS4 -->|ğŸ“Š Analytics Processing<br/>QueueAnalyticsService<br/>â€¢ Wait time metrics<br/>â€¢ Service time tracking<br/>â€¢ Peak hour analysis<br/>â€¢ Counter performance| ANALYTICS[Analytics Dashboard ğŸ“ˆ]
    
    %% === ERROR HANDLING & FALLBACK ===
    P5 -.->|ğŸš¨ SMS Failure<br/>Provider unavailable<br/>Invalid phone number| SMS_FALLBACK[SMS Fallback<br/>ğŸ”„ Retry mechanism<br/>ğŸ“‹ Manual notification<br/>ğŸ“ Phone call option]
    
    P5 -.->|ğŸš¨ Audio System Down<br/>Hardware failure<br/>Volume issues| AUDIO_FALLBACK[Audio Fallback<br/>ğŸ“¢ Manual announcement<br/>ğŸ”” Alternative alerts]
    
    %% === REAL-TIME SYNC ===
    WEBSOCKET -->|ğŸ”„ Real-time Updates<br/>â€¢ Queue position changes<br/>â€¢ Customer called events<br/>â€¢ Service completions<br/>â€¢ Counter status| DISPLAY
    
    %% === NOTIFICATION TEMPLATES ===
    SMS_TEMPLATES[SMS Templates ğŸ“<br/>â€¢ queue_position: Position updates<br/>â€¢ ready_to_serve: Call notification<br/>â€¢ delay_notification: Wait time<br/>â€¢ pickup_reminder: Service ready]
    SMS --> SMS_TEMPLATES
    
    %% === STYLING ===
    classDef processNode fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef datastoreNode fill:#f3e5f5,stroke:#4a148c,stroke-width:3px,color:#000
    classDef entityNode fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px,color:#000
    classDef systemNode fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#000
    classDef analyticsNode fill:#f0f4c3,stroke:#827717,stroke-width:3px,color:#000
    classDef fallbackNode fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000,stroke-dasharray:5,5
    
    class P1,P2,P3,P4,P5,P6,P7 processNode
    class DS1,DS2,DS3,DS4 datastoreNode  
    class STAFF,CUST entityNode
    class DISPLAY,AUDIO,WEBSOCKET,SMS systemNode
    class ANALYTICS,SMS_TEMPLATES analyticsNode
    class SMS_FALLBACK,AUDIO_FALLBACK fallbackNode

    %% === PROCESS ANNOTATIONS ===
    P1_NOTE["ğŸ” P1 Details:<br/>â€¢ Check queue_status='waiting'<br/>â€¢ Apply priority algorithm<br/>â€¢ Calculate wait times<br/>â€¢ Validate counter availability"]
    P2_NOTE["ğŸ¯ P2 Details:<br/>â€¢ SELECT TOP 1 with priority<br/>â€¢ Senior: +1000, PWD: +900, Pregnant: +800<br/>â€¢ FIFO within same priority<br/>â€¢ Fetch customer contact info"]
    P3_NOTE["ğŸ“ P3 Details:<br/>â€¢ UPDATE queue_status='serving'<br/>â€¢ Record call timestamp<br/>â€¢ Track position in queue<br/>â€¢ Generate analytics event"]
    P4_NOTE["ğŸª P4 Details:<br/>â€¢ Link customer to counter<br/>â€¢ Update counter status<br/>â€¢ Set staff assignment<br/>â€¢ Validate counter availability"]
    P5_NOTE["ğŸ”” P5 Details:<br/>â€¢ Multi-channel notifications<br/>â€¢ SMS via Vonage API<br/>â€¢ WebSocket real-time updates<br/>â€¢ Audio TTS announcement<br/>â€¢ Display visual updates"]
    P6_NOTE["âœ… P6 Details:<br/>â€¢ Mark service complete<br/>â€¢ Calculate service duration<br/>â€¢ Free up counter<br/>â€¢ Update analytics<br/>â€¢ Performance tracking"]
    P7_NOTE["ğŸš« P7 Details:<br/>â€¢ Handle no-show scenario<br/>â€¢ Log cancellation reason<br/>â€¢ Free up counter<br/>â€¢ Option to re-queue<br/>â€¢ Analytics tracking"]
    
    P1 -.-> P1_NOTE
    P2 -.-> P2_NOTE  
    P3 -.-> P3_NOTE
    P4 -.-> P4_NOTE
    P5 -.-> P5_NOTE
    P6 -.-> P6_NOTE
    P7 -.-> P7_NOTE
    
    class P1_NOTE,P2_NOTE,P3_NOTE,P4_NOTE,P5_NOTE,P6_NOTE,P7_NOTE processNode
